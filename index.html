<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Діна збирає мушлі</title>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
        body { background: #000; }
        #hud {
            position: relative;
            width: 100%;
            height: 50px;
            background: rgba(0,0,0,0.5);
            color: #fff;
            font-family: sans-serif;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            box-sizing: border-box;
        }
        #hud .hud-left { display: flex; align-items: center; }
        #hud .hud-left span { margin-right: 20px; }
        #hud .hud-left img.icon { vertical-align: middle; margin-right: 5px; }
        #hud .hud-right img { cursor: pointer; width: 32px; height: 32px; }
        img.icon { width: 32px; height: 32px; }
        #game-container { position: relative; width: 100%; height: calc(100% - 50px); }
        #mobile-controls { width: 100%; text-align: center; display: none; }
        .ctrl-btn {
            background: rgba(0,0,0,0.5);
            border: 2px solid #fff;
            color: #fff;
            font-size: 24px;
            width: 50px;
            height: 50px;
            margin: 5px;
            border-radius: 5px;
        }
        .ctrl-btn:active { background: rgba(255,255,255,0.3); }
        #gameCanvas { display: block; background: url("backgrounds/bg1.jpg") no-repeat center center; background-size: cover; }
        #gameover {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            font-family: sans-serif;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        #gameover.hidden { display: none; }
    </style>
</head>
<body>
    <div id="hud">
        <div class="hud-left">
            <span><img src="icons/shell.png" class="icon" alt="мушлі"/> <span id="score">0</span></span>
            <span><img src="icons/hourglass.png" class="icon" alt="час"/> <span id="time">60</span></span>
            <span>Рівень: <span id="level">1</span></span>
        </div>
        <div class="hud-right">
            <img id="sound-btn" src="icons/sound-on.png" alt="Звук" title="Звук"/>
        </div>
    </div>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="gameover" class="hidden"></div>
        <div id="mobile-controls">
            <button class="ctrl-btn" data-dir="left">←</button>
            <button class="ctrl-btn" data-dir="up">↑</button>
            <button class="ctrl-btn" data-dir="down">↓</button>
            <button class="ctrl-btn" data-dir="right">→</button>
        </div>
    </div>
    <script>
        const playerImg = new Image();
        playerImg.src = "yachts/yacht1.png";
        const shellImg = new Image();
        shellImg.src = "icons/shell.png";
        const music = new Audio("music/yachting-song.MP3");
        music.loop = true;
        music.volume = 0.5;
        let canvas = document.getElementById("gameCanvas");
        let ctx = canvas.getContext("2d");
        let hud = document.getElementById("hud");
        let scoreElem = document.getElementById("score");
        let timeElem = document.getElementById("time");
        let levelElem = document.getElementById("level");
        let soundBtn = document.getElementById("sound-btn");
        let gameoverElem = document.getElementById("gameover");
        const mobileControls = document.getElementById("mobile-controls");
        const ctrlButtons = document.querySelectorAll("#mobile-controls .ctrl-btn");
        let score = 0;
        let level = 1;
        let timeLeft = 60;
        let gameRunning = false;
        let player = { x: 0, y: 0, width: 0, height: 0, baseWidth: 0, baseHeight: 0, scale: 1 };
        let shell = { x: 0, y: 0, width: 0, height: 0 };
        let pressed = { left: false, up: false, down: false, right: false };
        let baseSpeed = 0;
        let currentSpeed = 0;
        function initGame() {
            const hudHeight = hud.offsetHeight;
            let controlsHeight = 0;
            const isMobile = window.matchMedia("(pointer: coarse)").matches;
            if (isMobile) {
                mobileControls.style.display = "block";
                controlsHeight = mobileControls.offsetHeight || 60;
            } else {
                mobileControls.style.display = "none";
            }
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - hudHeight - controlsHeight;
            let avgDim = (canvas.width + canvas.height) / 2;
            player.baseWidth = avgDim * 0.08;
            if (playerImg.naturalWidth > 0) {
                player.baseHeight = player.baseWidth * (playerImg.naturalHeight / playerImg.naturalWidth);
            } else {
                player.baseHeight = player.baseWidth;
            }
            player.width = player.baseWidth;
            player.height = player.baseHeight;
            player.x = canvas.width / 2;
            player.y = canvas.height / 2;
            shell.width = player.baseWidth * 0.6;
            if (shellImg.naturalWidth > 0) {
                shell.height = shell.width * (shellImg.naturalHeight / shellImg.naturalWidth);
            } else {
                shell.height = shell.width;
            }
            spawnShell();
            baseSpeed = avgDim * 0.25;
            updateSpeed();
        }
        function spawnShell() {
            const margin = 20;
            const minX = margin;
            const maxX = canvas.width - margin;
            const minY = margin;
            const maxY = canvas.height - margin;
            shell.x = Math.random() * (maxX - minX) + minX;
            shell.y = Math.random() * (maxY - minY) + minY;
        }
        function updateSpeed() {
            let levelFactor = 1 + 0.2 * (level - 1);
            currentSpeed = baseSpeed * levelFactor;
            if (timeLeft <= 10) {
                currentSpeed *= 1.5;
            }
        }
        function movePlayer(dt) {
            let dx = 0, dy = 0;
            if (pressed.left) dx -= 1;
            if (pressed.right) dx += 1;
            if (pressed.up) dy -= 1;
            if (pressed.down) dy += 1;
            if (dx !== 0 && dy !== 0) {
                dx *= Math.SQRT1_2;
                dy *= Math.SQRT1_2;
            }
            player.x += dx * currentSpeed * dt;
            player.y += dy * currentSpeed * dt;
            if (player.x < player.width/2) player.x = player.width/2;
            if (player.x > canvas.width - player.width/2) player.x = canvas.width - player.width/2;
            if (player.y < player.height/2) player.y = player.height/2;
            if (player.y > canvas.height - player.height/2) player.y = canvas.height - player.height/2;
        }
        function checkCollision() {
            if (Math.abs(player.x - shell.x) < (player.width/2 + shell.width/2) &&
                Math.abs(player.y - shell.y) < (player.height/2 + shell.height/2)) {
                collectShell();
            }
        }
        function collectShell() {
            score++;
            scoreElem.textContent = score;
            player.scale *= 1.1;
            if (player.scale > 3) player.scale = 3;
            player.width = player.baseWidth * player.scale;
            player.height = player.baseHeight * player.scale;
            if (score % 5 === 0) {
                levelUp();
            }
            spawnShell();
        }
        function levelUp() {
            level++;
            levelElem.textContent = level;
            player.scale = 1;
            player.width = player.baseWidth;
            player.height = player.baseHeight;
            if (level <= 6) {
                canvas.style.backgroundImage = `url(backgrounds/bg${level}.jpg)`;
            } else {
                canvas.style.backgroundImage = "url(backgrounds/bg6.jpg)";
            }
            updateSpeed();
        }
        let lastTimestamp = 0;
        function gameLoop(timestamp) {
            if (!gameRunning) return;
            if (!lastTimestamp) lastTimestamp = timestamp;
            const dt = (timestamp - lastTimestamp) / 1000;
            lastTimestamp = timestamp;
            timeLeft -= dt;
            if (timeLeft < 0) timeLeft = 0;
            timeElem.textContent = Math.ceil(timeLeft);
            updateSpeed();
            movePlayer(dt);
            checkCollision();
            drawGame();
            if (timeLeft <= 0) {
                endGame();
            } else {
                requestAnimationFrame(gameLoop);
            }
        }
        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(shellImg, shell.x - shell.width/2, shell.y - shell.height/2, shell.width, shell.height);
            ctx.drawImage(playerImg, player.x - player.width/2, player.y - player.height/2, player.width, player.height);
        }
        function endGame() {
            gameRunning = false;
            gameoverElem.innerHTML = `<p>Час вичерпано!<br/>Ви зібрали ${score} мушель.<br/><small>Натисніть, щоб почати спочатку.</small></p>`;
            gameoverElem.classList.remove("hidden");
        }
        function restartGame() {
            firstInteraction = true;
            score = 0;
            level = 1;
            timeLeft = 60;
            scoreElem.textContent = score;
            levelElem.textContent = level;
            canvas.style.backgroundImage = "url('backgrounds/bg1.jpg')";
            player.scale = 1;
            player.width = player.baseWidth;
            player.height = player.baseHeight;
            player.x = canvas.width / 2;
            player.y = canvas.height / 2;
            spawnShell();
            updateSpeed();
            gameoverElem.classList.add("hidden");
            lastTimestamp = 0;
            gameRunning = true;
            if (soundEnabled && music.paused) {
                try { music.play(); } catch(e) {}
            }
            requestAnimationFrame(gameLoop);
        }
        document.addEventListener("keydown", function(e) {
            if (!gameRunning && gameoverElem && !gameoverElem.classList.contains("hidden")) {
                restartGame();
            }
            if (e.code === "ArrowLeft" || e.code === "KeyA") { pressed.left = true; userInteraction(); }
            if (e.code === "ArrowRight" || e.code === "KeyD") { pressed.right = true; userInteraction(); }
            if (e.code === "ArrowUp" || e.code === "KeyW") { pressed.up = true; userInteraction(); }
            if (e.code === "ArrowDown" || e.code === "KeyS") { pressed.down = true; userInteraction(); }
        });
        document.addEventListener("keyup", function(e) {
            if (e.code === "ArrowLeft" || e.code === "KeyA") pressed.left = false;
            if (e.code === "ArrowRight" || e.code === "KeyD") pressed.right = false;
            if (e.code === "ArrowUp" || e.code === "KeyW") pressed.up = false;
            if (e.code === "ArrowDown" || e.code === "KeyS") pressed.down = false;
        });
        ctrlButtons.forEach(btn => {
            const dir = btn.getAttribute("data-dir");
            btn.addEventListener("pointerdown", function(e) {
                e.preventDefault();
                if (dir === "left") pressed.left = true;
                if (dir === "right") pressed.right = true;
                if (dir === "up") pressed.up = true;
                if (dir === "down") pressed.down = true;
                userInteraction();
            });
            btn.addEventListener("pointerup", function(e) {
                e.preventDefault();
                if (dir === "left") pressed.left = false;
                if (dir === "right") pressed.right = false;
                if (dir === "up") pressed.up = false;
                if (dir === "down") pressed.down = false;
            });
            btn.addEventListener("pointerout", function(e) {
                if (dir === "left") pressed.left = false;
                if (dir === "right") pressed.right = false;
                if (dir === "up") pressed.up = false;
                if (dir === "down") pressed.down = false;
            });
        });
        let soundEnabled = true;
        soundBtn.addEventListener("click", function() {
            soundEnabled = !soundEnabled;
            if (soundEnabled) {
                soundBtn.src = "icons/sound-on.png";
                if (gameRunning) {
                    try { if (music.paused) music.play(); } catch(err) {}
                }
            } else {
                soundBtn.src = "icons/sound-off.png";
                music.pause();
            }
        });
        let firstInteraction = false;
        function userInteraction() {
            if (!firstInteraction) {
                firstInteraction = true;
                if (soundEnabled && music.paused) {
                    music.play().catch(err => { console.warn("Автовідтворення звуку заборонено"); });
                }
                if (!gameRunning) {
                    gameRunning = true;
                    requestAnimationFrame(gameLoop);
                }
            }
        }
        gameoverElem.addEventListener("click", function() {
            if (!gameRunning) {
                restartGame();
            }
        });
        window.addEventListener("resize", function() {
            const oldWidth = canvas.width;
            const oldHeight = canvas.height;
            initGame();
            player.x *= canvas.width / oldWidth;
            player.y *= canvas.height / oldHeight;
            shell.x *= canvas.width / oldWidth;
            shell.y *= canvas.height / oldHeight;
            if (!gameRunning) {
                drawGame();
            }
        });
        window.addEventListener("load", function() {
            initGame();
            gameoverElem.innerHTML = `<div><img src="icons/dina.png" alt="Діна" style="max-width:150px; width:50%; height:auto; display:block; margin:0 auto 20px;"/>Натисніть, щоб розпочати гру</div>`;
            gameoverElem.classList.remove("hidden");
        });
    </script>
</body>
</html>
