<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Діна збирає мушлі</title>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; background: #000; color: #fff; touch-action: none; -webkit-user-select: none; -ms-user-select: none; user-select: none; }
    canvas { display: block; margin: 0 auto; background: #000; }
    /* Кнопки керування для сенсорних пристроїв (горизонтальна лінія внизу) */
    .controls { display: none; position: fixed; bottom: 0; width: 100%; justify-content: center; align-items: center; padding: 10px 0; }
    .controls img { width: 15vw; height: 15vw; max-width: 80px; max-height: 80px; margin: 0 5vw; touch-action: none; }
    @media (pointer: coarse) {
      .controls { display: flex; }
    }
  </style>
</head>
<body>
  <!-- Поле гри -->
  <canvas id="gameCanvas"></canvas>
  <!-- Кнопки керування для мобільних гравців -->
  <div class="controls">
    <img src="icons/left.png" id="btnLeft" alt="Вліво">
    <img src="icons/up.png" id="btnUp" alt="Вгору">
    <img src="icons/down.png" id="btnDown" alt="Вниз">
    <img src="icons/right.png" id="btnRight" alt="Вправо">
  </div>

  <script>
    // Основні змінні гри
    const FPS = 60;
    const DINA_SPEED = 5; // швидкість Діни (пікселів за кадр, ~300 пікселів/сек)
    let currentLevel = 1;
    const maxLevel = 6;
    let score = 0;
    let timeLeft = 60; // секунд залишилось на рівні
    let shells = []; // масив мушель (позиції)
    const shellRadius = 20;
    // Об'єкти для Діни та яхти
    let dina = { x: 0, y: 0, width: 0, height: 0 };
    let yacht = { x: 0, y: 0, width: 0, height: 0 };
    let baseYachtSpeed = 0; // базова швидкість яхти (пікселів за кадр)
    // Стан натискання клавіш керування
    let moveLeft = false, moveRight = false, moveUp = false, moveDown = false;
    // Зображення
    const bgImg = new Image();
    const dinaImg = new Image();
    const yachtImg = new Image();
    const shellImg = new Image();
    const hourglassImg = new Image();
    const soundOnImg = new Image();
    const soundOffImg = new Image();
    // Аудіо (фоновий звук)
    const backgroundMusic = new Audio("music/music.mp3");
    backgroundMusic.loop = true;
    let soundEnabled = true;
    // Canvas
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // Завантаження зображень
    bgImg.src = `backgrounds/bg${currentLevel}.jpg`;
    dinaImg.src = "icons/dina.png";
    yachtImg.src = "yachts/yacht1.png";
    shellImg.src = "icons/shell.png";
    hourglassImg.src = "icons/hourglass.png";
    soundOnImg.src = "icons/sound-on.png";
    soundOffImg.src = "icons/sound-off.png";

    // Початкові позиції Діни та яхти
    function initPositions() {
      // Діна починає знизу по центру
      dina.width = 50;
      dina.height = 50;
      dina.x = canvas.width / 2 - dina.width / 2;
      dina.y = canvas.height - dina.height - 10;
      // Яхта починає зверху по центру
      yacht.width = 60;
      yacht.height = 60;
      yacht.x = canvas.width / 2 - yacht.width / 2;
      yacht.y = 10;
    }

    // Створити нову мушлю у випадковій позиції
    function spawnShell() {
      const margin = 20;
      const x = margin + Math.random() * (canvas.width - 2 * margin);
      const y = margin + Math.random() * (canvas.height - 2 * margin);
      shells.push({ x: x, y: y });
    }

    // Підготувати мушлі на початку рівня (наприклад, 5 штук)
    function initShells() {
      shells = [];
      for (let i = 0; i < 5; i++) {
        spawnShell();
      }
    }

    // Перехід на наступний рівень
    function nextLevel() {
      if (currentLevel < maxLevel) {
        currentLevel++;
        // Змінюємо фон на наступний
        bgImg.src = `backgrounds/bg${currentLevel}.jpg`;
        // Задаємо базову швидкість яхти для нового рівня
        setYachtSpeedForLevel();
        // Скидаємо таймер
        timeLeft = 60;
        // Початкові позиції та мушлі
        initPositions();
        initShells();
      } else {
        // Якщо пройдено останній рівень, почати заново (можна додати екран завершення гри)
        currentLevel = 1;
        bgImg.src = `backgrounds/bg${currentLevel}.jpg`;
        score = 0;
        setYachtSpeedForLevel();
        timeLeft = 60;
        initPositions();
        initShells();
      }
    }

    // Динамічна складність: швидкість яхти згідно з рівнем
    function setYachtSpeedForLevel() {
      // На 1 рівні швидкість яхти ~4–5 разів менша за швидкість Діни (~60–75 пікселів/сек)
      // З кожним рівнем швидкість яхти поступово зростає
      const baseSpeeds = [1, 1.5, 2, 3, 4, 5]; // пікселів за кадр для рівнів 1–6
      baseYachtSpeed = baseSpeeds[currentLevel - 1] || baseSpeeds[baseSpeeds.length - 1];
    }

    // Обробка натискання клавіш керування (клавіатура)
    document.addEventListener("keydown", function(e) {
      if (e.code === "ArrowLeft" || e.code === "KeyA") moveLeft = true;
      if (e.code === "ArrowRight" || e.code === "KeyD") moveRight = true;
      if (e.code === "ArrowUp" || e.code === "KeyW") moveUp = true;
      if (e.code === "ArrowDown" || e.code === "KeyS") moveDown = true;
      // При першій дії користувача запускаємо музику, якщо звук увімкнено
      if (soundEnabled && backgroundMusic.paused) {
        backgroundMusic.play().catch(err => { /* ігноруємо помилки авто-відтворення */ });
      }
    });
    document.addEventListener("keyup", function(e) {
      if (e.code === "ArrowLeft" || e.code === "KeyA") moveLeft = false;
      if (e.code === "ArrowRight" || e.code === "KeyD") moveRight = false;
      if (e.code === "ArrowUp" || e.code === "KeyW") moveUp = false;
      if (e.code === "ArrowDown" || e.code === "KeyS") moveDown = false;
    });

    // Обробка натискання на кнопки керування (сенсорні екрани)
    const btnLeft = document.getElementById("btnLeft");
    const btnRight = document.getElementById("btnRight");
    const btnUp = document.getElementById("btnUp");
    const btnDown = document.getElementById("btnDown");
    function enableTouchControl(button, directionFlag) {
      button.addEventListener("pointerdown", function(e) {
        e.preventDefault();
        // При дотику до екрану також запускаємо музику (перший користувацький ввід)
        if (soundEnabled && backgroundMusic.paused) {
          backgroundMusic.play().catch(err => {});
        }
        switch(directionFlag) {
          case "left": moveLeft = true; break;
          case "right": moveRight = true; break;
          case "up": moveUp = true; break;
          case "down": moveDown = true; break;
        }
      });
      button.addEventListener("pointerup", function(e) {
        e.preventDefault();
        switch(directionFlag) {
          case "left": moveLeft = false; break;
          case "right": moveRight = false; break;
          case "up": moveUp = false; break;
          case "down": moveDown = false; break;
        }
      });
      // Якщо палець вийшов за межі кнопки або подію скасовано
      button.addEventListener("pointercancel", function(e) {
        switch(directionFlag) {
          case "left": moveLeft = false; break;
          case "right": moveRight = false; break;
          case "up": moveUp = false; break;
          case "down": moveDown = false; break;
        }
      });
    }
    enableTouchControl(btnLeft, "left");
    enableTouchControl(btnRight, "right");
    enableTouchControl(btnUp, "up");
    enableTouchControl(btnDown, "down");

    // Перемикач звуку при натисканні на іконку звуку на екрані
    canvas.addEventListener("click", function(e) {
      const rect = canvas.getBoundingClientRect();
      const cx = e.clientX - rect.left;
      const cy = e.clientY - rect.top;
      const iconSize = 32;
      if (cx >= canvas.width - iconSize - 10 && cy <= iconSize + 10) {
        toggleSound();
      }
    });
    function toggleSound() {
      soundEnabled = !soundEnabled;
      if (!soundEnabled) {
        backgroundMusic.pause();
      } else {
        backgroundMusic.play().catch(err => {});
      }
    }

    // Оновлення стану гри (логіка руху та зіткнень)
    function updateGame() {
      // Рух Діни згідно натиснутих кнопок (з перевіркою меж екрану)
      if (moveLeft && dina.x > 0) {
        dina.x -= DINA_SPEED;
        if (dina.x < 0) dina.x = 0;
      }
      if (moveRight && dina.x < canvas.width - dina.width) {
        dina.x += DINA_SPEED;
        if (dina.x > canvas.width - dina.width) dina.x = canvas.width - dina.width;
      }
      if (moveUp && dina.y > 0) {
        dina.y -= DINA_SPEED;
        if (dina.y < 0) dina.y = 0;
      }
      if (moveDown && dina.y < canvas.height - dina.height) {
        dina.y += DINA_SPEED;
        if (dina.y > canvas.height - dina.height) dina.y = canvas.height - dina.height;
      }

      // Рух яхти (штучний інтелект: прямувати до найближчої мушлі)
      let effectiveSpeed = baseYachtSpeed;
      if (timeLeft <= 10) {
        // Тимчасове пришвидшення яхти у останні 10 секунд рівня
        effectiveSpeed = baseYachtSpeed * 1.5;
      }
      if (shells.length > 0) {
        // знайти найближчу мушлю
        let nearestIndex = 0;
        let nearestDistSq = Number.MAX_VALUE;
        for (let i = 0; i < shells.length; i++) {
          let dx = shells[i].x - yacht.x;
          let dy = shells[i].y - yacht.y;
          let distSq = dx*dx + dy*dy;
          if (distSq < nearestDistSq) {
            nearestDistSq = distSq;
            nearestIndex = i;
          }
        }
        let target = shells[nearestIndex];
        // рухаємо яхту до цілі
        if (target.x < yacht.x) {
          yacht.x -= effectiveSpeed;
          if (yacht.x < 0) yacht.x = 0;
        } else if (target.x > yacht.x) {
          yacht.x += effectiveSpeed;
          if (yacht.x > canvas.width - yacht.width) yacht.x = canvas.width - yacht.width;
        }
        if (target.y < yacht.y) {
          yacht.y -= effectiveSpeed;
          if (yacht.y < 0) yacht.y = 0;
        } else if (target.y > yacht.y) {
          yacht.y += effectiveSpeed;
          if (yacht.y > canvas.height - yacht.height) yacht.y = canvas.height - yacht.height;
        }
      }
      // Перевірка: збір мушель Діною або яхтою
      for (let i = shells.length - 1; i >= 0; i--) {
        const shell = shells[i];
        // Діна збирає мушлю
        if (Math.abs(shell.x - (dina.x + dina.width/2)) < shellRadius && Math.abs(shell.y - (dina.y + dina.height/2)) < shellRadius) {
          shells.splice(i, 1);
          score++;
          continue;
        }
        // Яхта збирає мушлю
        if (Math.abs(shell.x - (yacht.x + yacht.width/2)) < shellRadius && Math.abs(shell.y - (yacht.y + yacht.height/2)) < shellRadius) {
          shells.splice(i, 1);
          // рахунок яхти не відображається, просто видаляємо мушлю
          continue;
        }
      }
      // Задаємо появу нових мушель з часом (наприклад, раз на 2 секунди)
      if (Math.random() < 1 / (FPS * 2)) {
        spawnShell();
      }
      // Зменшуємо таймер
      if (timeLeft > 0) {
        timeLeft -= 1 / FPS;
        if (timeLeft < 0) timeLeft = 0;
      }
      // Якщо час рівня вийшов – перехід на наступний рівень
      if (timeLeft <= 0) {
        nextLevel();
      }
    }

    // Малювання кадру гри
    function drawGame() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Фон
      if (bgImg.complete) {
        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
      }
      // Мушлі
      for (let shell of shells) {
        if (shellImg.complete) {
          ctx.drawImage(shellImg, shell.x - shellRadius/2, shell.y - shellRadius/2, shellRadius, shellRadius);
        } else {
          ctx.fillStyle = "#ccc";
          ctx.beginPath();
          ctx.arc(shell.x, shell.y, shellRadius/2, 0, 2*Math.PI);
          ctx.fill();
        }
      }
      // Діна
      if (dinaImg.complete) {
        ctx.drawImage(dinaImg, dina.x, dina.y, dina.width, dina.height);
      } else {
        ctx.fillStyle = "#0f0";
        ctx.fillRect(dina.x, dina.y, dina.width, dina.height);
      }
      // Яхта
      if (yachtImg.complete) {
        ctx.drawImage(yachtImg, yacht.x, yacht.y, yacht.width, yacht.height);
      } else {
        ctx.fillStyle = "#f00";
        ctx.fillRect(yacht.x, yacht.y, yacht.width, yacht.height);
      }
      // Рахунок (іконка мушлі + число)
      if (shellImg.complete) {
        ctx.drawImage(shellImg, 10, 10, 24, 24);
      }
      ctx.fillStyle = "#fff";
      ctx.font = "20px Arial";
      ctx.fillText(score, 40, 30);
      // Таймер (іконка годинника + секунди)
      if (hourglassImg.complete) {
        ctx.drawImage(hourglassImg, canvas.width/2 - 30, 10, 24, 24);
      }
      const timeText = Math.ceil(timeLeft);
      ctx.fillText(timeText, canvas.width/2, 30);
      // Рівень та звук (правий верхній кут)
      ctx.fillText(currentLevel, canvas.width - 30, 30);
      if (soundEnabled) {
        if (soundOnImg.complete) {
          ctx.drawImage(soundOnImg, canvas.width - 60, 10, 24, 24);
        }
      } else {
        if (soundOffImg.complete) {
          ctx.drawImage(soundOffImg, canvas.width - 60, 10, 24, 24);
        }
      }
    }

    // Запуск ігрового циклу (60 кадрів/сек)
    function gameLoop() {
      updateGame();
      drawGame();
      requestAnimationFrame(gameLoop);
    }

    // Адаптивність: масштабування canvas під екран (співвідношення 9:16)
    function resizeCanvas() {
      let controlHeight = 0;
      const controlsDiv = document.querySelector(".controls");
      if (controlsDiv && window.matchMedia("(pointer: coarse)").matches) {
        controlHeight = controlsDiv.offsetHeight || 100;
      }
      const availW = window.innerWidth;
      const availH = window.innerHeight - controlHeight;
      const ratio = 9 / 16;
      let newW, newH;
      if (availW / availH > ratio) {
        newH = availH;
        newW = newH * ratio;
      } else {
        newW = availW;
        newH = newW * (1 / ratio);
        if (newH > availH) {
          newH = availH;
          newW = newH * ratio;
        }
      }
      canvas.width = newW;
      canvas.height = newH;
      initPositions();
    }

    // Початкова ініціалізація
    setYachtSpeedForLevel();
    initPositions();
    initShells();
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);
    window.addEventListener("load", resizeCanvas);
    // Запускаємо гру
    requestAnimationFrame(gameLoop);
  </script>
</body>
</html>
