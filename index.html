<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Діна збирає мушлі</title>
<style>
    /* Стилі для body та canvas */
    html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        position: relative; /* для позиціонування накладених елементів */
        background: #000; /* запасний колір фону */
        touch-action: none; /* вимкнення стандартних жестів (скролл/масштаб) на мобільних */
    }
    canvas, img {
        -webkit-touch-callout: none;
        user-select: none;
        -webkit-user-select: none;
        -webkit-user-drag: none;
    }
    #gameCanvas {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 0;
        /* canvas size will be set by script for exact pixels, but ensure no scrollbars if slightly off */
        display: block;
    }
    #hud {
        position: absolute;
        top: 5px;
        left: 5px;
        right: 5px;
        z-index: 2;
        font: bold 18px sans-serif;
        color: #fff;
        text-shadow: 1px 1px 2px #000;
        /* За бажанням, напівпрозорий фон для HUD для кращої читабельності */
        /* background: rgba(0,0,0,0.3); border-radius: 5px; padding: 5px; */
        display: flex;
        justify-content: space-between;
        align-items: center;
        pointer-events: none; /* allow clicks through HUD (except on sound button which we will set pointer-events separately) */
    }
    #hud .left-hud {
        /* контейнер для лічильника мушель */
        pointer-events: none;
    }
    #hud .center-hud {
        text-align: center;
        flex: 1;
        pointer-events: none;
    }
    #hud .right-hud {
        /* контейнер для кнопки звуку */
        text-align: right;
        pointer-events: auto; /* дозволяємо натискання на кнопку звуку */
    }
    #hud img.icon {
        vertical-align: middle;
        /* можливо, змінити розмір іконки відносно тексту */
        width: 24px;
        height: 24px;
    }
    #hud #soundIcon {
        cursor: pointer;
        width: 32px;
        height: 32px;
        vertical-align: middle;
        /* pointer-events тут не потрібен, оскільки батьківський елемент вже має pointer-events: auto */
    }
    #controls {
        position: absolute;
        bottom: 10px;
        width: 100%;
        text-align: center;
        z-index: 2;
    }
    #controls img {
        width: 15vw;
        max-width: 100px;
        height: auto;
        touch-action: none; /* забороняє стандартні жести (наприклад, подвійний тап зум на iOS) */
    }
    #controls img:active {
        /* необов'язковий візуальний ефект при натисканні */
        opacity: 0.7;
    }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="hud">
    <div class="left-hud">
        <img src="icons/shell.png" class="icon" alt="Shell"> 
        <span id="shellCount">0</span>
    </div>
    <div class="center-hud">
        <img src="icons/timer.png" class="icon" alt="Timer"> 
        <span id="timer">00:00</span>
        &nbsp;&nbsp;
        <span id="levelLabel">Рівень: <span id="level">1</span></span>
    </div>
    <div class="right-hud">
        <img id="soundIcon" src="icons/sound-on.png" alt="Sound">
    </div>
</div>
<div id="controls">
    <img id="btnLeft" src="icons/left.png" alt="Left">
    <img id="btnUp" src="icons/up.png" alt="Up">
    <img id="btnDown" src="icons/down.png" alt="Down">
    <img id="btnRight" src="icons/right.png" alt="Right">
</div>
<script>
/*** Змінні гри ***/
// Стан гри
let shellsCollected = 0;
let level = 1;
let timeElapsed = 0;
let gameInterval = null; // таймер
let currentBackground = null;
// Діна (гравець)
let dinaX = 0, dinaY = 0;
let dinaScale = 1;
const DINA_SPEED = 5; // швидкість руху Діни у пікселях за кадр (~300px/сек при 60fps)
// Мушля (предмет)
let shellX = 0, shellY = 0;
let shellActive = false;
// Яхта (ворог)
let yachtX = 0, yachtY = 0;
let yachtSpeed = 0; // встановлюється відповідно до рівня
// Стан клавіш керування
let leftPressed = false, rightPressed = false, upPressed = false, downPressed = false;
// Звук та музика
const audio = new Audio('music/yachting-song.MP3');
audio.loop = true;
audio.preload = 'auto';
let soundEnabled = true;
let audioStarted = false;

/*** Блокування стандартних дій (контекстне меню, виділення) на мобільних ***/
function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}
if (isMobile()) {
    // Вимикаємо контекстне меню (довге натискання) та виділення на мобільному
    document.addEventListener('contextmenu', function(e) { e.preventDefault(); });
    document.addEventListener('selectstart', function(e) { e.preventDefault(); });
} 

/*** Завантаження зображень ***/
const dinaImg = new Image();
const shellImg = new Image();
const yachtImg = new Image();
const backgrounds = [];
for (let i = 1; i <= 6; i++) {
    backgrounds[i-1] = new Image();
    backgrounds[i-1].src = 'backgrounds/bg' + i + '.jpg';
}
dinaImg.src = 'icons/dina.png';
shellImg.src = 'icons/shell.png';
yachtImg.src = 'yachts/yacht1.png';

let imagesToLoad = 6 + 3; // 6 фонів + Діна + мушля + яхта
let imagesLoadedCount = 0;
function imageLoaded() {
    imagesLoadedCount++;
    if (imagesLoadedCount === imagesToLoad) {
        startGame();
    }
}
// Додаємо обробники onload
backgrounds.forEach(img => { img.onload = imageLoaded; });
dinaImg.onload = imageLoaded;
shellImg.onload = imageLoaded;
yachtImg.onload = imageLoaded;

/*** Ініціалізація гри ***/
function startGame() {
    // Встановлюємо розмір canvas на весь екран (очікується портретна орієнтація)
    const controlBar = document.getElementById('controls');
    // Обчислюємо висоту панелі керування (за наявності)
    let controlHeight = 0;
    if (controlBar) {
        controlHeight = controlBar.offsetHeight;
    }
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight - controlHeight;
    if (canvas.height < 0) canvas.height = window.innerHeight; // про всяк випадок

    // Розміщуємо Діну по центру
    dinaScale = 1;
    dinaX = (canvas.width - dinaImg.width * dinaScale) / 2;
    dinaY = (canvas.height - dinaImg.height * dinaScale) / 2;
    // Створюємо першу мушлю та яхту
    shellsCollected = 0;
    level = 1;
    updateHUD();
    spawnShell();
    // Запускаємо таймер
    timeElapsed = 0;
    gameInterval = setInterval(function() {
        timeElapsed++;
        updateTimer();
    }, 1000);
    // Запускаємо ігровий цикл
    requestAnimationFrame(gameLoop);
}

/*** Обробка зміни розміру вікна для покриття всього екрану ***/
window.addEventListener('resize', function() {
    // Перерахунок розмірів
    const controlBar = document.getElementById('controls');
    let controlHeight = controlBar ? controlBar.offsetHeight : 0;
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight - controlHeight;
    if (canvas.height < 0) canvas.height = window.innerHeight;
    // Коригуємо позицію Діни, якщо вона виходить за межі
    if (dinaX + dinaImg.width * dinaScale > canvas.width) {
        dinaX = canvas.width - dinaImg.width * dinaScale;
    }
    if (dinaY + dinaImg.height * dinaScale > canvas.height) {
        dinaY = canvas.height - dinaImg.height * dinaScale;
    }
    if (dinaX < 0) dinaX = 0;
    if (dinaY < 0) dinaY = 0;
    // Коригуємо мушлю, якщо вона виходить за межі
    if (shellActive) {
        if (shellX + shellImg.width > canvas.width || shellY + shellImg.height > canvas.height) {
            // Якщо поточна мушля тепер поза межами canvas, створюємо її знову
            spawnShell();
        }
    }
});

/*** Створення нової мушлі та перезапуск яхти ***/
function spawnShell() {
    // Визначаємо поточний фон (рівні понад 6 використовують bg6)
    let bgIndex = level <= 6 ? level - 1 : 5;
    currentBackground = backgrounds[bgIndex];
    // Встановлюємо швидкість яхти відповідно до рівня
    yachtSpeed = 2 + 0.5 * (level - 1);
    // Випадкова позиція мушлі (щоб не під HUD)
    const hudElem = document.getElementById('hud');
    let hudHeight = hudElem ? hudElem.offsetHeight : 0;
    // Гарантуємо, що мушля з'являється в межах canvas
    let maxX = canvas.width - shellImg.width;
    let maxY = canvas.height - shellImg.height;
    let minY = hudHeight + 5; // трохи нижче HUD
    if (minY < 0) minY = 0;
    shellX = Math.random() * (maxX >= 0 ? maxX : 0);
    shellY = minY + Math.random() * ((maxY > minY ? maxY : minY) - minY);
    shellActive = true;
    // Розміщуємо яхту на випадковому краю, за межами canvas
    const edge = Math.floor(Math.random() * 4); // 0:ліворуч,1:праворуч,2:зверху,3:знизу
    if (edge === 0) { // лівий край
        yachtX = -yachtImg.width;
        yachtY = Math.random() * (canvas.height - yachtImg.height);
    } else if (edge === 1) { // правий край
        yachtX = canvas.width + yachtImg.width;
        yachtY = Math.random() * (canvas.height - yachtImg.height);
    } else if (edge === 2) { // зверху
        yachtX = Math.random() * (canvas.width - yachtImg.width);
        yachtY = -yachtImg.height;
    } else if (edge === 3) { // знизу
        yachtX = Math.random() * (canvas.width - yachtImg.width);
        yachtY = canvas.height + yachtImg.height;
    }
}

/*** Оновлення HUD ***/
function updateHUD() {
    document.getElementById('shellCount').textContent = shellsCollected;
    document.getElementById('level').textContent = level;
}
function updateTimer() {
    // Форматуємо час як мм:сс
    const minutes = Math.floor(timeElapsed / 60);
    const seconds = timeElapsed % 60;
    const minStr = minutes < 10 ? '0' + minutes : '' + minutes;
    const secStr = seconds < 10 ? '0' + seconds : '' + seconds;
    document.getElementById('timer').textContent = minStr + ':' + secStr;
}

/*** Ігровий цикл ***/
function gameLoop() {
    // Очищаємо canvas, малюючи фон (покриває всю область, без чорних полів)
    if (currentBackground) {
        // Масштабування: фон покриває весь canvas
        const bg = currentBackground;
        const scale = Math.max(canvas.width / bg.width, canvas.height / bg.height);
        const bgW = bg.width * scale;
        const bgH = bg.height * scale;
        const bgX = (canvas.width - bgW) / 2;
        const bgY = (canvas.height - bgH) / 2;
        ctx.drawImage(bg, bgX, bgY, bgW, bgH);
    } else {
        // Якщо фон ще не завантажився, заповнюємо чорним
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    // Малюємо мушлю, якщо вона активна
    if (shellActive) {
        ctx.drawImage(shellImg, shellX, shellY);
    }
    // Малюємо Діну (гравець)
    ctx.drawImage(dinaImg, dinaX, dinaY, dinaImg.width * dinaScale, dinaImg.height * dinaScale);
    // Малюємо яхту (ворог)
    ctx.drawImage(yachtImg, yachtX, yachtY);
    // Оновлюємо позиції для наступного кадру
    // Рухаємо Діну відповідно до керування
    if (leftPressed) {
        dinaX -= DINA_SPEED;
    }
    if (rightPressed) {
        dinaX += DINA_SPEED;
    }
    if (upPressed) {
        dinaY -= DINA_SPEED;
    }
    if (downPressed) {
        dinaY += DINA_SPEED;
    }
    // Залишаємо Діну в межах поля
    if (dinaX < 0) dinaX = 0;
    if (dinaY < 0) dinaY = 0;
    if (dinaX + dinaImg.width * dinaScale > canvas.width) {
        dinaX = canvas.width - dinaImg.width * dinaScale;
    }
    if (dinaY + dinaImg.height * dinaScale > canvas.height) {
        dinaY = canvas.height - dinaImg.height * dinaScale;
    }
    // Рухаємо яхту до мушлі
    if (shellActive) {
        const dx = shellX + shellImg.width/2 - (yachtX + yachtImg.width/2);
        const dy = shellY + shellImg.height/2 - (yachtY + yachtImg.height/2);
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < yachtSpeed) {
            // Якщо яхта досягне або промине мушлю за цей кадр
            yachtX = shellX;
            yachtY = shellY;
        } else {
            // Нормалізуємо напрямок та рухаємо
            const ux = dx / dist;
            const uy = dy / dist;
            yachtX += ux * yachtSpeed;
            yachtY += uy * yachtSpeed;
        }
    }
    // Перевіряємо зіткнення
    if (shellActive) {
        // Перевіряємо, чи Діна зібрала мушлю
        if (
            dinaX < shellX + shellImg.width &&
            dinaX + dinaImg.width * dinaScale > shellX &&
            dinaY < shellY + shellImg.height &&
            dinaY + dinaImg.height * dinaScale > shellY
        ) {
            // Діна дісталася мушлі
            shellsCollected++;
            // Поступово збільшуємо розмір Діни до 3x
            if (dinaScale < 3) {
                dinaScale += 0.08;
                if (dinaScale > 3) dinaScale = 3;
            }
            // Підвищуємо рівень кожні 5 мушель
            if (shellsCollected % 5 === 0) {
                level++;
            }
            updateHUD();
            // Прибираємо мушлю (зібрано)
            shellActive = false;
            // Створюємо нову мушлю та перезапускаємо яхту
            spawnShell();
        } else {
            // Перевіряємо, чи яхта перехопила мушлю
            if (
                yachtX < shellX + shellImg.width &&
                yachtX + yachtImg.width > shellX &&
                yachtY < shellY + shellImg.height &&
                yachtY + yachtImg.height > shellY
            ) {
                // Яхта схопила мушлю
                shellActive = false;
                // Не збільшуємо лічильник мушель чи рівень
                // Створюємо нову мушлю (рівень не змінюється)
                spawnShell();
            }
        }
    }
    // Продовжуємо цикл
    requestAnimationFrame(gameLoop);
}

/*** Обробники подій для керування ***/
// Керування з клавіатури
window.addEventListener('keydown', function(e) {
    switch (e.key) {
        case 'ArrowLeft':
        case 'Left': // для старих браузерів
            leftPressed = true;
            e.preventDefault();
            break;
        case 'ArrowRight':
        case 'Right': // для старих браузерів
            rightPressed = true;
            e.preventDefault();
            break;
        case 'ArrowUp':
        case 'Up': // для старих браузерів
            upPressed = true;
            e.preventDefault();
            break;
        case 'ArrowDown':
        case 'Down': // для старих браузерів
            downPressed = true;
            e.preventDefault();
            break;
        default:
            return;
    }
    // Запускаємо музику після першої взаємодії
    if (!audioStarted && soundEnabled) {
        audio.play().catch(err => { /* обробка помилки програвання (якщо є) */ });
        audioStarted = true;
    }
});
window.addEventListener('keyup', function(e) {
    switch (e.key) {
        case 'ArrowLeft':
        case 'Left':
            leftPressed = false;
            e.preventDefault();
            break;
        case 'ArrowRight':
        case 'Right':
            rightPressed = false;
            e.preventDefault();
            break;
        case 'ArrowUp':
        case 'Up':
            upPressed = false;
            e.preventDefault();
            break;
        case 'ArrowDown':
        case 'Down':
            downPressed = false;
            e.preventDefault();
            break;
        default:
            return;
    }
});

// Сенсорне керування для кнопок на екрані
function handleTouchStart(direction) {
    if (direction === 'left') leftPressed = true;
    if (direction === 'right') rightPressed = true;
    if (direction === 'up') upPressed = true;
    if (direction === 'down') downPressed = true;
    // Запускаємо музику після першої взаємодії
    if (!audioStarted && soundEnabled) {
        audio.play().catch(err => {});
        audioStarted = true;
    }
}
function handleTouchEnd(direction) {
    if (direction === 'left') leftPressed = false;
    if (direction === 'right') rightPressed = false;
    if (direction === 'up') upPressed = false;
    if (direction === 'down') downPressed = false;
}

// Додаємо сенсорні обробники до кнопок керування
document.getElementById('btnLeft').addEventListener('touchstart', function(e) {
    e.preventDefault();
    handleTouchStart('left');
});
document.getElementById('btnLeft').addEventListener('touchend', function(e) {
    e.preventDefault();
    handleTouchEnd('left');
});
document.getElementById('btnUp').addEventListener('touchstart', function(e) {
    e.preventDefault();
    handleTouchStart('up');
});
document.getElementById('btnUp').addEventListener('touchend', function(e) {
    e.preventDefault();
    handleTouchEnd('up');
});
document.getElementById('btnDown').addEventListener('touchstart', function(e) {
    e.preventDefault();
    handleTouchStart('down');
});
document.getElementById('btnDown').addEventListener('touchend', function(e) {
    e.preventDefault();
    handleTouchEnd('down');
});
document.getElementById('btnRight').addEventListener('touchstart', function(e) {
    e.preventDefault();
    handleTouchStart('right');
});
document.getElementById('btnRight').addEventListener('touchend', function(e) {
    e.preventDefault();
    handleTouchEnd('right');
});

// Кнопка перемикання звуку
document.getElementById('soundIcon').addEventListener('click', function() {
    if (soundEnabled) {
        // Вимикаємо звук
        soundEnabled = false;
        this.src = 'icons/sound-off.png';
        if (!audio.paused) {
            audio.pause();
        }
    } else {
        // Увімкнути звук
        soundEnabled = true;
        this.src = 'icons/sound-on.png';
        if (audioStarted) {
            // Відновлюємо відтворення, якщо вже було розпочато
            audio.play().catch(err => {});
        } else {
            // Якщо ще не розпочато (можливо, користувач вимкнув звук до старту), запускаємо зараз
            audio.play().catch(err => {});
            audioStarted = true;
        }
    }
});
</script>
</body>
</html>
